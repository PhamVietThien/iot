<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aquarium Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Hi·ªáu ·ª©ng nh·∫•p nh√°y cho tr·∫°ng th√°i reset */
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-600 tracking-tight">üêü B·ªÉ C√° Th√¥ng Minh</h1>
            <p class="text-gray-500 mt-2">H·ªá th·ªëng gi√°m s√°t & ƒëi·ªÅu khi·ªÉn IoT</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="space-y-6">
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="font-bold text-gray-800 text-lg mb-4 flex items-center">
                        üéõÔ∏è ƒêi·ªÅu khi·ªÉn
                    </h2>
                    <div class="space-y-3">
                        <button id="btnAuto" onclick="toggleDevice('autoMode')" class="w-full py-4 rounded-xl font-bold text-white transition-all transform active:scale-95 shadow-md bg-gray-400">
                            ƒêang t·∫£i...
                        </button>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="btnPump" onclick="toggleDevice('pump')" class="py-4 rounded-xl font-bold text-white transition-all shadow-md bg-gray-400">
                                M√°y B∆°m
                            </button>
                            <button id="btnLight" onclick="toggleDevice('light')" class="py-4 rounded-xl font-bold text-white transition-all shadow-md bg-gray-400">
                                ƒê√®n LED
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="font-bold text-gray-800 text-lg mb-4 flex items-center">
                        üìä Tr·∫°ng Th√°i
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-xl text-center border border-blue-100">
                            <p class="text-sm text-gray-500 mb-1">Nhi·ªát ƒë·ªô</p>
                            <p class="text-3xl font-bold text-blue-600"><span id="temperature">--</span>¬∞C</p>
                        </div>
                        <div class="bg-cyan-50 p-4 rounded-xl text-center border border-cyan-100">
                            <p class="text-sm text-gray-500 mb-1">M·ª±c n∆∞·ªõc</p>
                            <p class="text-3xl font-bold text-cyan-600"><span id="waterLevel">--</span> mm</p>
                        </div>
                    </div>

                    <div class="bg-indigo-50 rounded-xl p-4 border border-indigo-100">
                        <h3 class="text-xs font-bold text-indigo-800 uppercase tracking-wide mb-3 border-b border-indigo-200 pb-2">
                            üì° K·∫øt n·ªëi m·∫°ng
                        </h3>
                        <div class="grid grid-cols-2 gap-y-2 text-sm">
                            <div class="text-gray-600">WiFi SSID:</div>
                            <div id="wifiName" class="font-bold text-gray-800 text-right">Checking...</div>
                            
                            <div class="text-gray-600">T√≠n hi·ªáu (RSSI):</div>
                            <div id="wifiSignal" class="font-bold text-right text-gray-500">-- dBm</div>
                            
                            <div class="text-gray-600">IP Address:</div>
                            <div id="wifiIP" class="font-mono text-right text-gray-600">...</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="font-bold text-gray-800 text-lg mb-4">‚öôÔ∏è C√†i ƒë·∫∑t</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ng∆∞·ª°ng b∆°m t·ª± ƒë·ªông (mm)</label>
                        <div class="flex gap-2">
                            <input type="number" id="thresholdInput" class="flex-1 border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="100">
                            <button onclick="setThreshold()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium">L∆∞u</button>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">L·ªãch b·∫≠t ƒë√®n</label>
                        <div class="flex items-center gap-2">
                            <input type="time" id="lightOn" class="border rounded-lg px-2 py-2 w-full">
                            <span class="text-gray-400">‚ûú</span>
                            <input type="time" id="lightOff" class="border rounded-lg px-2 py-2 w-full">
                            <button onclick="setLightSchedule()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-medium">ƒê·∫∑t</button>
                        </div>
                    </div>

                    <div class="pt-4 mt-4 border-t border-gray-100">
                        <button onclick="requestWifiReset()" class="w-full py-3 bg-red-50 text-red-600 border border-red-200 rounded-lg hover:bg-red-100 font-bold text-sm transition flex justify-center items-center gap-2">
                            ‚ö†Ô∏è Reset WiFi & C·∫•u h√¨nh l·∫°i
                        </button>
                    </div>
                </div>

            </div>

            <div class="bg-gray-900 text-gray-300 p-6 rounded-2xl shadow-lg h-[600px] flex flex-col font-mono text-sm">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <h2 class="font-bold text-white">üìú System Logs</h2>
                    <span class="text-xs text-green-400 animate-pulse">‚óè Live</span>
                </div>
                <div id="logContainer" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                    <p class="text-gray-500 italic">ƒêang t·∫£i nh·∫≠t k√Ω...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN CH√çNH ---
        async function fetchState() {
            try {
                const res = await fetch('/state');
                const data = await res.json();

                // C·∫≠p nh·∫≠t N√∫t
                updateButton('btnAuto', data.autoMode, 'ü§ñ Ch·∫ø ƒë·ªô T·ª± ƒê·ªông', 'ü§ñ Ch·∫ø ƒë·ªô Th·ªß C√¥ng');
                updateButton('btnPump', data.pump, 'üåä M√°y B∆°m: B·∫¨T', 'üåä M√°y B∆°m: T·∫ÆT');
                updateButton('btnLight', data.light, 'üí° ƒê√®n: B·∫¨T', 'üí° ƒê√®n: T·∫ÆT');

                // C·∫≠p nh·∫≠t C·∫£m bi·∫øn
                document.getElementById('temperature').innerText = data.temperature;
                document.getElementById('waterLevel').innerText = data.waterLevel;

                // C·∫≠p nh·∫≠t Setting inputs (ch·ªâ g√°n khi ch∆∞a focus ƒë·ªÉ ko l√†m phi·ªÅn ng∆∞·ªùi nh·∫≠p)
                if(document.activeElement.id !== 'thresholdInput') 
                    document.getElementById('thresholdInput').placeholder = data.threshold;
                
                if(data.lightSchedule) {
                    if(document.activeElement.id !== 'lightOn') document.getElementById('lightOn').value = data.lightSchedule.on;
                    if(document.activeElement.id !== 'lightOff') document.getElementById('lightOff').value = data.lightSchedule.off;
                }

                // --- C·∫¨P NH·∫¨T WIFI INFO (M·ªöI) ---
                updateWifiInfo(data);

            } catch (err) {
                console.error("L·ªói fetchState:", err);
            }
        }

        // H√†m ph·ª• c·∫≠p nh·∫≠t n√∫t b·∫•m
        function updateButton(id, state, textOn, textOff) {
            const btn = document.getElementById(id);
            if (state === 1) {
                btn.textContent = textOn;
                btn.className = btn.className.replace(/bg-gray-400|bg-red-500/g, 'bg-green-500 hover:bg-green-600');
            } else {
                btn.textContent = textOff;
                btn.className = btn.className.replace(/bg-green-500/g, 'bg-gray-400 hover:bg-gray-500');
            }
            
            // X·ª≠ l√Ω ri√™ng cho n√∫t Auto ƒë·ªÉ n√≥ n·ªïi b·∫≠t h∆°n
            if(id === 'btnAuto') {
                if(state === 1) btn.className = "w-full py-4 rounded-xl font-bold text-white shadow-md bg-blue-600 hover:bg-blue-700";
                else btn.className = "w-full py-4 rounded-xl font-bold text-white shadow-md bg-gray-500 hover:bg-gray-600";
            }
        }

        // H√†m ph·ª• hi·ªÉn th·ªã WiFi
        function updateWifiInfo(data) {
            const nameEl = document.getElementById('wifiName');
            const rssiEl = document.getElementById('wifiSignal');
            const ipEl = document.getElementById('wifiIP');

            if (data.wifiSSID) {
                nameEl.textContent = data.wifiSSID;
                if (data.wifiSSID === "Reseting..." || data.wifiSSID === "Disconnect") {
                    nameEl.className = "font-bold text-right text-red-500 blink"; // Nh·∫•p nh√°y ƒë·ªè
                } else {
                    nameEl.className = "font-bold text-right text-green-600";
                }
            }

            if (data.rssi) {
                const rssi = parseInt(data.rssi);
                rssiEl.textContent = rssi + " dBm";
                // M√†u s√≥ng
                if (rssi > -60) rssiEl.style.color = "#16a34a"; // Xanh l√°
                else if (rssi > -80) rssiEl.style.color = "#ea580c"; // Cam
                else rssiEl.style.color = "#dc2626"; // ƒê·ªè
            }

            if (data.ip) ipEl.textContent = data.ip;
        }

        // --- 2. H√ÄM ƒêI·ªÄU KHI·ªÇN ---
        async function toggleDevice(key) {
            try {
                // L·∫•y tr·∫°ng th√°i hi·ªán t·∫°i tr∆∞·ªõc
                const res = await fetch('/state');
                const state = await res.json();
                const currentVal = state[key] || 0;
                
                // G·ª≠i l·ªánh ƒë·∫£o ng∆∞·ª£c
                await fetch('/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [key]: currentVal ? 0 : 1 })
                });
                
                fetchState(); // C·∫≠p nh·∫≠t l·∫°i ngay
            } catch (err) { alert('L·ªói k·∫øt n·ªëi server'); }
        }

        async function setThreshold() {
            const val = document.getElementById('thresholdInput').value;
            if(!val) return;
            await fetch('/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ threshold: parseInt(val) })
            });
            alert("ƒê√£ l∆∞u ng∆∞·ª°ng b∆°m!");
        }

        async function setLightSchedule() {
            const on = document.getElementById('lightOn').value;
            const off = document.getElementById('lightOff').value;
            if(!on || !off) return alert("Vui l√≤ng ch·ªçn ƒë·ªß gi·ªù b·∫≠t v√† t·∫Øt");
            
            await fetch('/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lightSchedule: { on, off } })
            });
            alert("ƒê√£ l∆∞u l·ªãch ƒë√®n!");
        }

        // --- 3. H√ÄM RESET WIFI ---
        async function requestWifiReset() {
            if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO QUAN TR·ªåNG:\n\nThi·∫øt b·ªã s·∫Ω m·∫•t k·∫øt n·ªëi m·∫°ng v√† kh·ªüi ƒë·ªông l·∫°i.\nB·∫°n c·∫ßn k·∫øt n·ªëi v√†o WiFi 'FishTank_Config' ƒë·ªÉ c√†i ƒë·∫∑t l·∫°i.\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?")) {
                return;
            }

            // Giao di·ªán chuy·ªÉn sang tr·∫°ng th√°i ch·ªù
            document.getElementById('wifiName').textContent = "ƒêang g·ª≠i l·ªánh...";
            document.getElementById('wifiName').className = "font-bold text-right text-orange-500 blink";

            try {
                const res = await fetch('/reset-wifi', { method: 'POST' });
                const data = await res.json();
                
                if(data.success) {
                    alert("‚úÖ L·ªánh Reset ƒë√£ g·ª≠i th√†nh c√¥ng!\nƒê√®n tr√™n thi·∫øt b·ªã s·∫Ω nh√°y li√™n t·ª•c.");
                } else {
                    alert("‚ùå L·ªói: " + data.error);
                }
            } catch (err) {
                console.error(err);
                alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Server");
            }
        }

        // --- 4. H√ÄM LOGS ---
        async function fetchLog() {
            try {
                const res = await fetch('/log');
                const logs = await res.json();
                const container = document.getElementById('logContainer');
                container.innerHTML = '';

                logs.forEach(log => {
                    const div = document.createElement('div');
                    const time = new Date(log.timestamp).toLocaleTimeString('vi-VN');
                    
                    // M√†u s·∫Øc log
                    let colorClass = "text-gray-300";
                    if(log.source === 'auto') colorClass = "text-yellow-300";
                    if(log.source === 'button') colorClass = "text-purple-300";
                    if(log.source === 'web') colorClass = "text-blue-300";

                    div.className = `border-l-2 pl-2 border-gray-700 hover:bg-gray-800 p-1 rounded ${colorClass}`;
                    div.innerHTML = `<span class="text-gray-500 text-xs">[${time}]</span> ${log.message}`;
                    container.appendChild(div);
                });
            } catch (err) { console.error(err); }
        }

        // --- CH·∫†Y T·ª∞ ƒê·ªòNG ---
        setInterval(fetchState, 1000); // C·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªói gi√¢y
        setInterval(fetchLog, 3000);   // C·∫≠p nh·∫≠t log m·ªói 3 gi√¢y
        fetchState();
        fetchLog();
    </script>
</body>
</html>