<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Aquarium Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .blink { animation: blinker 1s linear infinite; } 
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8 min-h-screen font-sans">

    <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-3xl font-bold text-blue-600 mb-2">üîê ƒêƒÉng Nh·∫≠p</h2>
            <div class="space-y-4 mt-6">
                <input type="text" id="username" placeholder="User" class="w-full p-3 border rounded-lg outline-none focus:border-blue-500">
                <input type="password" id="password" placeholder="Pass" class="w-full p-3 border rounded-lg outline-none focus:border-blue-500">
                <button onclick="login()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition transform active:scale-95">
                    Truy C·∫≠p
                </button>
                <p id="loginError" class="text-red-500 text-sm hidden font-bold animate-pulse"></p>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto filter blur-sm transition duration-500" id="mainContent">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-xl shadow-sm">
            <div class="flex items-center gap-3">
                <span class="text-4xl">üê†</span>
                <div>
                    <h1 class="text-2xl font-extrabold text-slate-800">H·ªá Th·ªëng B·ªÉ C√° IoT</h1>
                    <p class="text-gray-500 text-xs">User: <span id="userDisplay" class="font-bold">...</span> | Role: <span id="roleDisplay" class="text-blue-600 font-bold">...</span></p>
                </div>
            </div>
            <button onclick="logout()" class="text-sm bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-100 transition">
                ƒêƒÉng xu·∫•t
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 space-y-6">
                
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="font-bold text-slate-700 mb-3 flex items-center gap-2">üîç Ki·ªÉm tra Auto</h2>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>M·ª±c n∆∞·ªõc hi·ªán t·∫°i</span>
                            <span>Ng∆∞·ª°ng c√†i ƒë·∫∑t</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex-1 bg-gray-200 rounded-full h-4 overflow-hidden relative">
                                <div id="waterBar" class="bg-cyan-500 h-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <span class="text-xs font-bold text-slate-700" id="monitorWater">0mm</span>
                        </div>
                        <div class="text-right text-xs text-orange-500 font-bold mt-1" id="monitorThreshold">Ng∆∞·ª°ng: 100mm</div>
                        <p id="pumpReason" class="text-xs italic text-gray-400 mt-1 text-center">...</p>
                    </div>

                    <div class="border-t pt-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-500">Gi·ªù hi·ªán t·∫°i: <span id="currentTime" class="font-bold text-slate-800">--:--</span></span>
                            <span class="text-xs text-purple-600 font-bold" id="monitorSchedule">L·ªãch: --:-- ‚ûú --:--</span>
                        </div>
                        <p id="lightReason" class="text-xs italic text-gray-400 mt-1 text-center">...</p>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden">
                    <div id="blockClickOverlay" class="hidden absolute inset-0 bg-slate-100 bg-opacity-60 z-10 flex items-center justify-center backdrop-blur-[1px]">
                        <span class="bg-slate-800 text-white text-xs px-3 py-1 rounded-full">Ch·∫ø ƒë·ªô xem</span>
                    </div>

                    <h2 class="font-bold text-slate-700 mb-3">üéõÔ∏è ƒêi·ªÅu khi·ªÉn</h2>
                    <button id="btnAuto" onclick="toggleDevice('autoMode')" class="w-full py-3 mb-3 rounded-xl font-bold text-white bg-gray-400 transition-all shadow-md">Auto Mode</button>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btnPump" onclick="toggleDevice('pump')" class="py-6 rounded-xl font-bold text-white bg-gray-400 transition-all shadow-md flex flex-col items-center justify-center gap-2">
                            <span>üåä</span> M√°y B∆°m
                        </button>
                        <button id="btnLight" onclick="toggleDevice('light')" class="py-6 rounded-xl font-bold text-white bg-gray-400 transition-all shadow-md flex flex-col items-center justify-center gap-2">
                            <span>üí°</span> ƒê√®n LED
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-xl text-center border border-blue-100">
                        <p class="text-xs text-gray-500">Nhi·ªát ƒë·ªô</p>
                        <p class="text-2xl font-bold text-blue-600"><span id="temperature">--</span>¬∞C</p>
                    </div>
                    <div class="bg-cyan-50 p-4 rounded-xl text-center border border-cyan-100">
                        <p class="text-xs text-gray-500">M·ª±c n∆∞·ªõc</p>
                        <p class="text-2xl font-bold text-cyan-600"><span id="waterLevel">--</span>mm</p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 h-full relative">
                    <h2 class="font-bold text-slate-700 mb-4 text-lg">‚öôÔ∏è C·∫•u H√¨nh H·ªá Th·ªëng</h2>
                    
                    <div id="settingsControls" class="space-y-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <label class="text-sm font-bold text-gray-700 block mb-2">üåä C√†i ƒë·∫∑t B∆°m (Ng∆∞·ª°ng c·∫°n)</label>
                            <div class="flex gap-2">
                                <input type="number" id="thresholdInput" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500" placeholder="Nh·∫≠p mm...">
                                <button onclick="setThreshold()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-bold shadow-sm">L∆∞u</button>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">*N·∫øu n∆∞·ªõc < ng∆∞·ª°ng n√†y, b∆°m s·∫Ω b·∫≠t (Auto).</p>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <label class="text-sm font-bold text-gray-700 block mb-2">üí° L·ªãch tr√¨nh ƒê√®n (B·∫≠t ‚ûú T·∫Øt)</label>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold w-8">ON:</span>
                                <input type="time" id="lightOn" class="border border-gray-300 rounded-lg px-2 py-2 w-full text-sm">
                            </div>
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-xs font-bold w-8">OFF:</span>
                                <input type="time" id="lightOff" class="border border-gray-300 rounded-lg px-2 py-2 w-full text-sm">
                            </div>
                            <button onclick="setLightSchedule()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-bold shadow-sm">C·∫≠p nh·∫≠t L·ªãch</button>
                        </div>

                        <div id="adminZone" class="hidden border-t-2 border-dashed border-gray-200 pt-4 mt-4">
                            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">V√πng Qu·∫£n Tr·ªã</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="requestWifiReset()" class="bg-red-100 text-red-600 py-2 rounded-lg text-xs font-bold hover:bg-red-200">
                                    üîÑ Reset WiFi
                                </button>
                                <button onclick="document.getElementById('newUserForm').classList.toggle('hidden')" class="bg-green-100 text-green-600 py-2 rounded-lg text-xs font-bold hover:bg-green-200">
                                    ‚ûï Th√™m User
                                </button>
                            </div>
                            
                            <div id="newUserForm" class="hidden mt-3 bg-white border p-3 rounded-lg shadow-inner">
                                <input id="newUser" type="text" placeholder="Username" class="w-full mb-2 p-1 border rounded text-xs">
                                <input id="newPass" type="text" placeholder="Password" class="w-full mb-2 p-1 border rounded text-xs">
                                <select id="newRole" class="w-full mb-2 p-1 border rounded text-xs">
                                    <option value="viewer">Viewer</option>
                                    <option value="admin">Admin</option>
                                </select>
                                <button onclick="createUser()" class="w-full bg-green-500 text-white text-xs font-bold py-1 rounded">X√°c nh·∫≠n</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                <div class="bg-gray-900 text-white p-6 rounded-2xl shadow-lg h-full border border-gray-800 flex flex-col">
                    <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3">
                        <h2 class="font-bold flex items-center gap-2 text-lg">üìä Th·ªëng K√™</h2>
                        <span class="text-xs text-green-400 bg-green-900 px-2 py-1 rounded-full">Live Data</span>
                    </div>

                    <div class="flex-1 space-y-6">
                        <div>
                            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-wider">H√¥m Nay</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-gray-800 p-3 rounded-lg text-center">
                                    <p class="text-xs text-gray-400">B·∫≠t B∆°m</p>
                                    <p class="text-xl font-bold text-cyan-400"><span id="statPumpDay">0</span> <span class="text-xs text-gray-500">l·∫ßn</span></p>
                                </div>
                                <div class="bg-gray-800 p-3 rounded-lg text-center">
                                    <p class="text-xs text-gray-400">B·∫≠t ƒê√®n</p>
                                    <p class="text-xl font-bold text-yellow-400"><span id="statLightDay">0</span> <span class="text-xs text-gray-500">l·∫ßn</span></p>
                                </div>
                                <div class="bg-gray-800 p-3 rounded-lg text-center">
                                    <p class="text-xs text-gray-400">TB Nhi·ªát ƒë·ªô</p>
                                    <p class="text-xl font-bold text-blue-400"><span id="statTempDay">--</span>¬∞C</p>
                                </div>
                                <div class="bg-gray-800 p-3 rounded-lg text-center">
                                    <p class="text-xs text-gray-400">TB M·ª±c n∆∞·ªõc</p>
                                    <p class="text-xl font-bold text-indigo-400"><span id="statWaterDay">--</span>mm</p>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-800">
                            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-wider">Th√°ng N√†y</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between border-b border-gray-800 pb-1">
                                    <span>T·ªïng l·∫ßn b·∫≠t B∆°m:</span>
                                    <span class="font-bold text-cyan-400" id="statPumpMonth">0</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-800 pb-1">
                                    <span>T·ªïng l·∫ßn b·∫≠t ƒê√®n:</span>
                                    <span class="font-bold text-yellow-400" id="statLightMonth">0</span>
                                </div>
                                <div class="flex justify-between border-b border-gray-800 pb-1">
                                    <span>Nhi·ªát ƒë·ªô TB:</span>
                                    <span class="font-bold text-blue-400" id="statTempMonth">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>M·ª±c n∆∞·ªõc TB:</span>
                                    <span class="font-bold text-indigo-400" id="statWaterMonth">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <p class="text-xs text-gray-600 italic">D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông m·ªói 10 ph√∫t</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- AUTH & VARIABLES ---
        let TOKEN = localStorage.getItem('token');
        let ROLE = localStorage.getItem('role');
        let USERNAME = localStorage.getItem('username');

        function checkAuth() {
            if (!TOKEN) {
                document.getElementById('loginModal').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                document.getElementById('mainContent').classList.add('filter', 'blur-sm', 'pointer-events-none');
            } else {
                document.getElementById('loginModal').classList.add('hidden', 'opacity-0', 'pointer-events-none');
                document.getElementById('mainContent').classList.remove('filter', 'blur-sm', 'pointer-events-none');
                
                document.getElementById('userDisplay').innerText = USERNAME;
                document.getElementById('roleDisplay').innerText = ROLE;
                
                if (ROLE !== 'admin') {
                    document.getElementById('adminZone').classList.add('hidden');
                    document.getElementById('blockClickOverlay').classList.remove('hidden');
                    document.getElementById('settingsControls').style.pointerEvents = 'none';
                    document.getElementById('settingsControls').style.opacity = '0.6';
                } else {
                    document.getElementById('adminZone').classList.remove('hidden');
                    document.getElementById('blockClickOverlay').classList.add('hidden');
                    document.getElementById('settingsControls').style.pointerEvents = 'auto';
                    document.getElementById('settingsControls').style.opacity = '1';
                }
                fetchState();
                fetchStats(); // L·∫•y th·ªëng k√™
            }
        }

        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const errEl = document.getElementById('loginError');
            if(!u || !p) { errEl.innerText = "Nh·∫≠p thi·∫øu th√¥ng tin"; errEl.classList.remove('hidden'); return; }

            try {
                const res = await fetch('/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p}) });
                const data = await res.json();
                if (data.success) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('role', data.role);
                    localStorage.setItem('username', data.username);
                    TOKEN = data.token; ROLE = data.role; USERNAME = data.username;
                    errEl.classList.add('hidden');
                    checkAuth();
                } else { errEl.innerText = data.error; errEl.classList.remove('hidden'); }
            } catch(e) { errEl.innerText = "L·ªói Server"; errEl.classList.remove('hidden'); }
        }

        function logout() { localStorage.clear(); location.reload(); }

        // --- API HELPER ---
        async function apiCall(endpoint, body) {
            const res = await fetch(endpoint, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': TOKEN }, body: JSON.stringify(body)
            });
            if(res.status === 403) { alert("‚õî Kh√¥ng c√≥ quy·ªÅn Admin!"); return null; }
            const data = await res.json();
            if(!data.success) alert("‚ùå L·ªói: " + data.error);
            return data;
        }

        // --- CONTROL ---
        async function toggleDevice(key) {
            if(ROLE !== 'admin') return; 
            
            const res = await fetch('/state');
            const state = await res.json();

            // --- ƒêO·∫†N M·ªöI: CH·∫∂N CLICK N·∫æU ƒêANG AUTO ---
            if (state.autoMode === 1 && key !== 'autoMode') {
                alert("‚ö†Ô∏è H·ªá th·ªëng ƒëang ch·∫°y t·ª± ƒë·ªông (Auto Mode).\nVui l√≤ng t·∫Øt Auto Mode tr∆∞·ªõc khi ƒëi·ªÅu khi·ªÉn th·ªß c√¥ng!");
                return;
            }
            // ------------------------------------------

            const current = state[key] || 0;
            await apiCall('/update', { [key]: current ? 0 : 1 });
            fetchState(); 
        }
        async function setThreshold() { 
            apiCall('/update', { threshold: parseInt(document.getElementById('thresholdInput').value) }); 
            alert("ƒê√£ l∆∞u ng∆∞·ª°ng!"); fetchState();
        }
        async function setLightSchedule() { 
            apiCall('/update', { lightSchedule: { on: document.getElementById('lightOn').value, off: document.getElementById('lightOff').value } });
            alert("ƒê√£ l∆∞u l·ªãch!"); fetchState();
        }
        async function requestWifiReset() { 
            if(confirm("‚ö†Ô∏è Reset WiFi?")) {
                const res = await apiCall('/reset-wifi', {});
                if(res && res.success) alert("‚úÖ L·ªánh Reset ƒë√£ g·ª≠i!");
            }
        }
        async function createUser() {
            const u = document.getElementById('newUser').value;
            const p = document.getElementById('newPass').value;
            const r = document.getElementById('newRole').value;
            if(!u || !p) return alert("Thi·∫øu th√¥ng tin");
            const data = await apiCall('/register', { newUsername: u, newPassword: p, newRole: r });
            if(data && data.success) { alert(data.message); }
        }

        // --- DISPLAY & MONITOR ---
        // --- DISPLAY FUNCTIONS ---
        async function fetchState() {
            if(!TOKEN) return;
            try {
                const res = await fetch('/state');
                const data = await res.json();
                
                // Ki·ªÉm tra xem c√≥ ƒëang Auto kh√¥ng
                const isAuto = data.autoMode === 1;

                // C·∫≠p nh·∫≠t n√∫t Auto
                updateButton('btnAuto', data.autoMode, 'ü§ñ T·ª± ƒê·ªông: B·∫¨T', 'ü§ñ T·ª± ƒê·ªông: T·∫ÆT', false);
                
                // C·∫≠p nh·∫≠t n√∫t B∆°m & ƒê√®n (Truy·ªÅn th√™m tham s·ªë isAuto ƒë·ªÉ kh√≥a n√∫t)
                updateButton('btnPump', data.pump, 
                    isAuto ? 'üåä B∆°m (ƒêang Auto)' : 'üåä M√°y B∆°m: ƒêANG CH·∫†Y', 
                    isAuto ? 'üåä B∆°m (ƒêang Auto)' : 'üåä M√°y B∆°m: ƒêANG T·∫ÆT', 
                    isAuto
                );
                
                updateButton('btnLight', data.light, 
                    isAuto ? 'üí° ƒê√®n (ƒêang Auto)' : 'üí° ƒê√®n LED: ƒêANG S√ÅNG', 
                    isAuto ? 'üí° ƒê√®n (ƒêang Auto)' : 'üí° ƒê√®n LED: ƒêANG T·∫ÆT', 
                    isAuto
                );

                document.getElementById('temperature').innerText = data.temperature;
                document.getElementById('waterLevel').innerText = data.waterLevel;
                
                // WiFi Info
                const wifiEl = document.getElementById('wifiName');
                wifiEl.innerText = data.wifiSSID;
                if(data.wifiSSID === 'Disconnect' || data.wifiSSID === 'Reseting...') {
                    wifiEl.className = 'font-bold text-right text-red-500 blink';
                } else {
                    wifiEl.className = 'font-bold text-right text-green-600';
                }
                document.getElementById('wifiIP').innerText = data.ip;
                document.getElementById('wifiSignal').innerText = data.rssi + " dBm";
                
                if(document.activeElement.id !== 'thresholdInput') document.getElementById('thresholdInput').placeholder = data.threshold;

            } catch(e) {}
        }

        // C·∫≠p nh·∫≠t h√†m updateButton ƒë·ªÉ h·ªó tr·ª£ kh√≥a n√∫t (disabled)
        function updateButton(id, state, txtOn, txtOff, isDisabled) {
            const btn = document.getElementById(id);
            
            // N·∫øu b·ªã kh√≥a (do Auto Mode)
            if (isDisabled) {
                btn.innerText = state ? txtOn : txtOff; // Gi·ªØ nguy√™n tr·∫°ng th√°i hi·ªÉn th·ªã
                btn.className = "w-full py-4 rounded-xl font-bold text-gray-500 shadow-none bg-gray-200 cursor-not-allowed border border-gray-300";
                btn.disabled = true; // Kh√≥a ch·ª©c nƒÉng click
                return;
            }

            // N·∫øu b√¨nh th∆∞·ªùng
            btn.disabled = false;
            if(state) {
                btn.innerText = txtOn;
                btn.className = "w-full py-4 rounded-xl font-bold text-white shadow-md bg-green-500 hover:bg-green-600 transition-all active:scale-95";
            } else {
                btn.innerText = txtOff;
                btn.className = "w-full py-4 rounded-xl font-bold text-white shadow-md bg-gray-400 hover:bg-gray-500 transition-all active:scale-95";
            }
        }

        // --- FETCH STATISTICS ---
        async function fetchStats() {
            if(!TOKEN) return;
            try {
                const res = await fetch('/stats');
                const data = await res.json();
                
                // Ng√†y
                document.getElementById('statPumpDay').innerText = data.day.pump;
                document.getElementById('statLightDay').innerText = data.day.light;
                document.getElementById('statTempDay').innerText = data.day.temp;
                document.getElementById('statWaterDay').innerText = data.day.water;

                // Th√°ng
                document.getElementById('statPumpMonth').innerText = data.month.pump + " l·∫ßn";
                document.getElementById('statLightMonth').innerText = data.month.light + " l·∫ßn";
                document.getElementById('statTempMonth').innerText = data.month.temp + " ¬∞C";
                document.getElementById('statWaterMonth').innerText = data.month.water + " mm";

            } catch(e) {}
        }
        // --- INIT ---
        checkAuth();
        setInterval(() => { if(TOKEN) fetchState(); }, 1000);
        setInterval(() => { if(TOKEN) fetchStats(); }, 10000); // C·∫≠p nh·∫≠t th·ªëng k√™ ch·∫≠m h∆°n (10s)
    </script>
</body>
</html>