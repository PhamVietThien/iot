<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaSmart Pro - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary: #4834d4; --success: #2ecc71; --danger: #eb4d4b; 
            --bg: #f5f6fa; --card-bg: rgba(255, 255, 255, 0.9);
        }
        
        body { 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed; margin: 0; min-height: 100vh;
        }

        .container { max-width: 1100px; margin: auto; padding: 20px; }
        .hidden { display: none !important; }

        /* Login Card */
        #loginPage {
            max-width: 400px; margin: 100px auto; padding: 40px;
            background: var(--card-bg); border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center;
        }

        /* Navbar */
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); padding: 15px 25px; border-radius: 15px;
            margin-bottom: 25px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        /* Card */
        .card { 
            background: var(--card-bg); padding: 25px; border-radius: 20px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }

        /* Stats */
        .stat-box { text-align: center; padding: 10px; }
        .stat-value { font-size: 3rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.9rem; font-weight: bold; color: #636e72; text-transform: uppercase; }

        /* Buttons */
        button { 
            padding: 14px; border: none; border-radius: 12px; cursor: pointer; 
            font-weight: 700; width: 100%; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        
        .btn-on { background: linear-gradient(to right, #2ecc71, #27ae60); color: white; }
        .btn-off { background: #dcdde1; color: #2f3640; }
        .btn-primary { background: linear-gradient(to right, #4834d4, #686de0); color: white; }
        .btn-logout { background: #f8f9fa; color: var(--danger); width: auto; padding: 8px 15px; border: 1px solid #eee; }

        /* Badge */
        .badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; float: right; }

        /* Table */
        .table-wrap { overflow-x: auto; border-radius: 12px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f1f2f6; padding: 15px; text-align: left; font-size: 0.8rem; color: #2f3640; }
        td { padding: 15px; border-top: 1px solid #eee; font-size: 0.9rem; }

        input { padding: 12px; border: 1px solid #ddd; border-radius: 10px; width: 100%; box-sizing: border-box; margin: 10px 0; }
        input:disabled { background-color: #f1f2f6; color: #7f8c8d; cursor: not-allowed; border: 1px dashed #bdc3c7; }
        
        .alert { background: var(--danger); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
    </style>
</head>
<body>

<div class="container">
    <div id="loginPage">
        <div style="font-size: 4rem; color: var(--primary); margin-bottom: 10px;"><i class="fas fa-water"></i></div>
        <h2 style="margin-bottom: 30px;">AquaSmart Pro</h2>
        <input type="text" id="userIn" placeholder="Tên đăng nhập">
        <input type="password" id="passIn" placeholder="Mật khẩu">
        <button onclick="login()" class="btn-primary">ĐĂNG NHẬP <i class="fas fa-arrow-right"></i></button>
    </div>

    <div id="mainPage" class="hidden">
        <div class="navbar">
            <h3 style="margin:0; color:var(--primary)"><i class="fas fa-fish"></i> AQUASMART 2025</h3>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="userNameDisplay" style="font-weight: bold; color: #2f3640;"></span>
                <button onclick="logout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Thoát</button>
            </div>
        </div>

        <div id="alertBox"></div>

        <div class="grid">
            <div class="card">
                <div class="stat-box">
                    <div class="stat-label">Nhiệt độ hiện tại</div>
                    <div class="stat-value"><span id="temp">--</span>°C</div>
                    <p style="margin-top: 15px; color: #636e72;">Mực nước: <b id="water">--</b> mm</p>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0"><i class="fas fa-sliders"></i> Điều khiển</h3>
                <button id="btnAuto" onclick="toggle('autoMode')" style="margin-bottom: 15px;">TỰ ĐỘNG: --</button>
                <div style="margin-bottom: 15px; position: relative;">
                    <span class="badge" id="pCount">0 lần</span>
                    <button id="btnPump" onclick="toggle('pump')"><i class="fas fa-faucet"></i> MÁY BƠM</button>
                </div>
                <div style="position: relative;">
                    <span class="badge" id="lCount">0 lần</span>
                    <button id="btnLight" onclick="toggle('light')"><i class="fas fa-lightbulb"></i> ĐÈN LED</button>
                </div>
            </div>

            <div id="configPanel" class="card">
                <h3 style="margin-top:0"><i class="fas fa-cog"></i> Thông số & Cài đặt</h3>
                
                <label style="font-size: 0.8rem; font-weight: bold;">NGƯỠNG BƠM (MM):</label>
                <input type="number" id="thIn" class="config-input" placeholder="Ví dụ: 150">
                
                <label style="font-size: 0.8rem; font-weight: bold;">HẸN GIỜ ĐÈN (BẬT - TẮT):</label>
                <div style="display:flex; gap:10px">
                    <input type="time" id="onIn" class="config-input">
                    <input type="time" id="offIn" class="config-input">
                </div>
                
                <button id="btnSaveConfig" onclick="saveConfig()" class="btn-primary hidden" style="margin-top: 10px;">
                    <i class="fas fa-save"></i> CẬP NHẬT CẤU HÌNH
                </button>

                <div id="onlyAdminSection" class="hidden">
                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                    <h4><i class="fas fa-user-plus"></i> Tạo tài khoản</h4>
                    <input type="text" id="uNew" placeholder="Tên người dùng mới">
                    <input type="password" id="pNew" placeholder="Mật khẩu mới">
                    <button onclick="regUser()" style="background:#2f3640; color:white">TẠO NGƯỜI DÙNG</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0"><i class="fas fa-history"></i> Thống kê & Nhật ký</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="date" id="filterDate" style="margin:0; flex-grow:1">
                <button onclick="loadHistory()" class="btn-primary" style="width:100px">LỌC</button>
                <button onclick="clearFilter()" style="width:100px; background:#95a5a6; color:white">XÓA</button>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 2.5fr;">
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Ngày</th><th>Bơm</th><th>Đèn</th></tr></thead>
                        <tbody id="statBody"></tbody>
                    </table>
                </div>
                <div class="table-wrap" style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead><tr><th>Giờ</th><th>Hành động</th><th>Nguồn</th></tr></thead>
                        <tbody id="logBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let token = ""; let role = ""; 
    let refreshInterval = null;

    window.onload = () => {
        const savedToken = localStorage.getItem('token');
        const savedRole = localStorage.getItem('role');
        if (savedToken) {
            token = savedToken; role = savedRole;
            initDashboard();
        }
    }

    async function login() {
        const res = await fetch('/api/login', { 
            method: 'POST', headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({username: userIn.value, password: passIn.value}) 
        });
        if (res.ok) {
            const data = await res.json();
            token = data.token; role = data.role;
            localStorage.setItem('token', token);
            localStorage.setItem('role', role);
            localStorage.setItem('username', data.username);
            initDashboard();
        } else alert("Đăng nhập thất bại! Kiểm tra lại tài khoản.");
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }

    function initDashboard() {
        loginPage.classList.add('hidden');
        mainPage.classList.remove('hidden');
        
        // Phân quyền hiển thị
        if (role === 'admin') {
            btnSaveConfig.classList.remove('hidden');
            onlyAdminSection.classList.remove('hidden');
            document.getElementById('userNameDisplay').innerHTML = `<i class="fas fa-user-shield"></i> Admin: ${localStorage.getItem('username')}`;
        } else {
            // Khóa các ô input nếu là user
            const inputs = document.querySelectorAll('.config-input');
            inputs.forEach(input => input.disabled = true);
            document.getElementById('userNameDisplay').innerHTML = `<i class="fas fa-user"></i> User: ${localStorage.getItem('username')}`;
        }

        updateState();
        refreshInterval = setInterval(updateState, 3000);
    }

    async function updateState() {
        if(!token) return;
        try {
            const res = await fetch('/state', { headers: {'Authorization': token} });
            if(res.status === 401) return logout();
            const s = await res.json();
            
            // Cập nhật cảm biến
            document.getElementById('temp').innerText = s.temperature;
            document.getElementById('water').innerText = s.distance_mm;
            alertBox.innerHTML = (s.alerts || []).map(m => `<div class="alert">${m}</div>`).join('');
            
            // Cập nhật trạng thái nút
            btnAuto.className = s.autoMode ? 'btn-on' : 'btn-off';
            btnAuto.innerText = `TỰ ĐỘNG: ${s.autoMode ? 'BẬT' : 'TẮT'}`;
            
            const isAuto = s.autoMode === 1;
            btnPump.disabled = isAuto;
            btnLight.disabled = isAuto;
            
            btnPump.className = isAuto ? 'btn-off' : (s.pump ? 'btn-on' : 'btn-off');
            btnLight.className = isAuto ? 'btn-off' : (s.light ? 'btn-on' : 'btn-off');

            // Cập nhật giá trị vào Input (Chỉ khi người dùng không đang gõ)
            if (document.activeElement.tagName !== 'INPUT') {
                thIn.value = s.threshold || "";
                onIn.value = s.lightSchedule?.on || ""; 
                offIn.value = s.lightSchedule?.off || ""; 
            }

            loadHistory();
        } catch (e) { console.error(e); }
    }

    async function toggle(key) {
        // Lấy trạng thái hiện tại trước khi toggle
        const s = await fetch('/state', { headers: {'Authorization': token} }).then(r => r.json());
        const newValue = s[key] ? 0 : 1;
        
        await fetch('/update', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json', 'Authorization': token}, 
            body: JSON.stringify({[key]: newValue}) 
        });
        updateState();
    }

    async function loadHistory() {
        try {
            const d = filterDate.value;
            const statsRes = await fetch(`/api/stats${d ? '?date='+d : ''}`, { headers: {'Authorization': token} });
            const stats = await statsRes.json();
            
            statBody.innerHTML = stats.filter ? 
                `<tr><td>${stats.date}</td><td>${stats.pump}</td><td>${stats.light}</td></tr>` : 
                (stats.stats || []).map(s => `<tr><td>${s._id}</td><td>${s.pump}</td><td>${s.light}</td></tr>`).join('');

            const today = new Date(Date.now() + 7*3600000).toISOString().split('T')[0];
            const ts = await fetch(`/api/stats?date=${today}`, { headers: {'Authorization': token} }).then(r => r.json());
            pCount.innerText = ts.pump + " lần"; lCount.innerText = ts.light + " lần";

            const logsRes = await fetch(`/api/logs${d ? '?date='+d : ''}`, { headers: {'Authorization': token} });
            const logs = await logsRes.json();
            logBody.innerHTML = logs.map(l => `
                <tr>
                    <td>${new Date(l.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</td>
                    <td><b>${l.action}</b></td>
                    <td>${l.source}</td>
                </tr>`).join('');
        } catch (err) {}
    }

    function clearFilter() { filterDate.value = ''; loadHistory(); }

    async function saveConfig() { 
        if (role !== 'admin') return;
        const res = await fetch('/config', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json', 'Authorization': token}, 
            body: JSON.stringify({ 
                threshold: thIn.value, 
                lightSchedule: {on: onIn.value, off: offIn.value} 
            }) 
        });
        if(res.ok) alert(" Cập nhật cấu hình thành công!");
    }

    async function regUser() { 
        if (role !== 'admin') return;
        const res = await fetch('/api/register', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json', 'Authorization': token}, 
            body: JSON.stringify({ username: uNew.value, password: pNew.value, role: 'user' }) 
        });
        if(res.ok) {
            alert(" Đã tạo người dùng mới!");
            uNew.value = ""; pNew.value = "";
        }
    }
</script>
</body>
</html>