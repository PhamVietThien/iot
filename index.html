<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaSmart Pro - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary: #4834d4; --success: #2ecc71; --danger: #eb4d4b; 
            --bg: #f5f6fa; --card-bg: rgba(255, 255, 255, 0.9);
        }
        
        body { 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed; margin: 0; min-height: 100vh;
        }

        .container { max-width: 1100px; margin: auto; padding: 20px; }
        .hidden { display: none !important; }

        #loginPage {
            max-width: 400px; margin: 100px auto; padding: 40px;
            background: var(--card-bg); border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center;
        }

        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); padding: 15px 25px; border-radius: 15px;
            margin-bottom: 25px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .card { 
            background: var(--card-bg); padding: 25px; border-radius: 20px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }

        /* Chỉ số cảm biến */
        .stat-box { text-align: center; padding: 10px; }
        .stat-value { font-size: 3rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.9rem; font-weight: bold; color: #636e72; text-transform: uppercase; }

        /* Hiệu ứng cá */
        .fish-quiet { color: #bdc3c7; transition: 0.3s; }
        .fish-active { color: #f39c12; font-weight: bold; animation: swim 1s infinite alternate; }
        @keyframes swim { from { transform: scale(1); } to { transform: scale(1.1); } }

        /* Nút bấm */
        button { 
            padding: 14px; border: none; border-radius: 12px; cursor: pointer; 
            font-weight: 700; width: 100%; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        
        .btn-on { background: linear-gradient(to right, #2ecc71, #27ae60); color: white; }
        .btn-off { background: #dcdde1; color: #2f3640; }
        .btn-primary { background: linear-gradient(to right, #4834d4, #686de0); color: white; }
        .btn-logout { background: #f8f9fa; color: var(--danger); width: auto; padding: 8px 15px; border: 1px solid #eee; }

        /* Badge số lần */
        .badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; float: right; }

        /* Bảng */
        .table-wrap { overflow-x: auto; border-radius: 12px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f1f2f6; padding: 15px; text-align: left; font-size: 0.8rem; color: #2f3640; }
        td { padding: 15px; border-top: 1px solid #eee; font-size: 0.9rem; }

        input { padding: 12px; border: 1px solid #ddd; border-radius: 10px; width: 100%; box-sizing: border-box; margin: 10px 0; }
        
        .alert { background: var(--danger); color: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; text-align: center; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
    </style>
</head>
<body>

<div class="container">
    <div id="loginPage">
        <div style="font-size: 4rem; color: var(--primary); margin-bottom: 10px;"><i class="fas fa-water"></i></div>
        <h2 style="margin-bottom: 30px;">AquaSmart Pro</h2>
        <input type="text" id="userIn" placeholder="Tên đăng nhập">
        <input type="password" id="passIn" placeholder="Mật khẩu">
        <button onclick="login()" class="btn-primary">ĐĂNG NHẬP <i class="fas fa-arrow-right"></i></button>
    </div>

    <div id="mainPage" class="hidden">
        <div class="navbar">
            <h3 style="margin:0; color:var(--primary)"><i class="fas fa-fish"></i> AQUASMART 2025</h3>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="userNameDisplay" style="font-weight: bold; color: #2f3640;"></span>
                <button onclick="logout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Thoát</button>
            </div>
        </div>

        <div id="alertBox"></div>

        <div class="grid">
            <div class="card">
                <div class="stat-box">
                    <div class="stat-label">Cảm biến hồ cá</div>
                    <div class="stat-value"><span id="temp">--</span>°C</div>
                    <div style="margin-top: 15px; display: flex; justify-content: center; gap: 20px;">
                        <p style="color: #636e72; margin:0;">Mực nước: <b id="water">--</b> mm</p>
                        <p id="fishStatus" class="fish-quiet" style="margin:0;">
                            <i class="fas fa-fish"></i> <span id="fishText">Yên tĩnh</span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0"><i class="fas fa-sliders"></i> Điều khiển</h3>
                <button id="btnAuto" onclick="toggle('autoMode')" style="margin-bottom: 15px;">TỰ ĐỘNG: --</button>
                <div style="margin-bottom: 15px; position: relative;">
                    <span class="badge" id="pCount">0 lần</span>
                    <button id="btnPump" onclick="toggle('pump')"><i class="fas fa-faucet"></i> MÁY BƠM</button>
                </div>
                <div style="position: relative;">
                    <span class="badge" id="lCount">0 lần</span>
                    <button id="btnLight" onclick="toggle('light')"><i class="fas fa-lightbulb"></i> ĐÈN LED</button>
                </div>
            </div>

            <div id="configPanel" class="card">
                <h3 style="margin-top:0"><i class="fas fa-cog"></i> Thông số & Cài đặt</h3>
                <label style="font-size: 0.8rem; font-weight: bold;">NGƯỠNG BƠM (MM):</label>
                <input type="number" id="thIn" class="config-input">
                <label style="font-size: 0.8rem; font-weight: bold;">HẸN GIỜ ĐÈN (BẬT - TẮT):</label>
                <div style="display:flex; gap:10px">
                    <input type="time" id="onIn" class="config-input">
                    <input type="time" id="offIn" class="config-input">
                </div>
                <button id="btnSaveConfig" onclick="saveConfig()" class="btn-primary" style="margin-top: 10px;">
                    <i class="fas fa-save"></i> CẬP NHẬT CẤU HÌNH
                </button>
                
                <div id="onlyAdminSection" class="hidden">
                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                    <h4><i class="fas fa-user-plus"></i> Tạo tài khoản mới</h4>
                    <input type="text" id="uNew" placeholder="Tên người dùng mới">
                    <input type="password" id="pNew" placeholder="Mật khẩu mới">
                    <button onclick="regUser()" style="background:#2f3640; color:white">TẠO NGƯỜI DÙNG</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0"><i class="fas fa-history"></i> Thống kê & Nhật ký</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="date" id="filterDate" style="margin:0; flex-grow:1">
                <button onclick="loadData()" class="btn-primary" style="width:100px">LỌC</button>
                <button onclick="clearFilter()" style="width:100px; background:#95a5a6; color:white">XÓA</button>
            </div>
            <div class="grid" style="grid-template-columns: 1fr 2.5fr;">
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Ngày</th><th>Bơm</th><th>Đèn</th></tr></thead>
                        <tbody id="statBody"></tbody>
                    </table>
                </div>
                <div class="table-wrap" style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead><tr><th>Giờ</th><th>Hành động</th><th>Nguồn</th></tr></thead>
                        <tbody id="logBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let token = localStorage.getItem('token');
    let role = localStorage.getItem('role');

    if (token) initDashboard();

    async function login() {
        const res = await fetch('/api/login', { 
            method: 'POST', headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({username: userIn.value, password: passIn.value}) 
        });
        if (res.ok) {
            const data = await res.json();
            token = data.token; role = data.role;
            localStorage.setItem('token', token);
            localStorage.setItem('role', role);
            localStorage.setItem('username', data.username);
            initDashboard();
        } else alert("Đăng nhập thất bại!");
    }

    function logout() { localStorage.clear(); location.reload(); }

    function initDashboard() {
        loginPage.classList.add('hidden');
        mainPage.classList.remove('hidden');
        userNameDisplay.innerHTML = `<i class="fas fa-${role==='admin'?'user-shield':'user'}"></i> ${role==='admin'?'Admin':'User'}: ${localStorage.getItem('username')}`;
        
        if (role === 'admin') {
            onlyAdminSection.classList.remove('hidden');
        } else {
            document.querySelectorAll('.config-input').forEach(i => i.disabled = true);
            btnSaveConfig.classList.add('hidden');
        }

        updateState();
        loadData();
        setInterval(updateState, 3000);
    }

    async function updateState() {
        try {
            const res = await fetch('/state', { headers: {'Authorization': token} });
            if (res.status === 401) logout();
            const s = await res.json();

            document.getElementById('temp').innerText = s.temperature;
            document.getElementById('water').innerText = s.distance_mm;
            
            const fStatus = document.getElementById('fishStatus');
            const fText = document.getElementById('fishText');
            if (s.fish === 1) {
                fStatus.className = "fish-active"; fText.innerText = "CÁ ĐANG QUẪY";
            } else {
                fStatus.className = "fish-quiet"; fText.innerText = "Yên tĩnh";
            }

            alertBox.innerHTML = (s.alerts || []).map(m => `<div class="alert">${m}</div>`).join('');

            btnAuto.className = s.autoMode ? 'btn-on' : 'btn-off';
            btnAuto.innerText = `TỰ ĐỘNG: ${s.autoMode ? 'BẬT' : 'TẮT'}`;
            
            const isAuto = s.autoMode === 1;
            btnPump.disabled = isAuto; btnLight.disabled = isAuto;
            btnPump.className = s.pump ? 'btn-on' : 'btn-off';
            btnLight.className = s.light ? 'btn-on' : 'btn-off';

            if (document.activeElement.tagName !== 'INPUT') {
                thIn.value = s.threshold;
                onIn.value = s.lightSchedule?.on || "";
                offIn.value = s.lightSchedule?.off || "";
            }
        } catch (e) {}
    }

    async function toggle(key) {
        const res = await fetch('/state', { headers: {'Authorization': token} });
        const s = await res.json();
        const newVal = s[key] ? 0 : 1;

        await fetch('/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': token},
            body: JSON.stringify({ [key]: newVal })
        });
        updateState();
        setTimeout(loadData, 500); 
    }

    async function saveConfig() {
        const body = {
            threshold: parseInt(thIn.value),
            lightSchedule: { on: onIn.value, off: offIn.value }
        };
        await fetch('/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': token},
            body: JSON.stringify(body)
        });
        alert("Đã cập nhật cấu hình!");
    }

    async function loadData() {
        try {
            const date = filterDate.value;
            const res = await fetch(`/api/logs${date ? '?date=' + date : ''}`, { 
                headers: {'Authorization': token} 
            });
            const logs = await res.json();

            logBody.innerHTML = logs.map(l => `
                <tr>
                    <td>${new Date(l.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td><b>${l.action}</b></td>
                    <td>${l.source}</td>
                </tr>
            `).join('');

            const statsMap = {};
            logs.forEach(l => {
                if (!statsMap[l.dateStr]) statsMap[l.dateStr] = { pump: 0, light: 0 };
                if (l.action.includes("Máy bơm: BẬT")) statsMap[l.dateStr].pump++;
                if (l.action.includes("Đèn LED: BẬT")) statsMap[l.dateStr].light++;
            });

            statBody.innerHTML = Object.keys(statsMap).map(d => `
                <tr><td>${d}</td><td>${statsMap[d].pump}</td><td>${statsMap[d].light}</td></tr>
            `).join('');

            const today = new Date(Date.now() + 7 * 3600000).toISOString().split('T')[0];
            pCount.innerText = (statsMap[today]?.pump || 0) + " lần";
            lCount.innerText = (statsMap[today]?.light || 0) + " lần";

        } catch (e) {}
    }

    function clearFilter() { filterDate.value = ''; loadData(); }

    async function regUser() {
        if (!uNew.value || !pNew.value) return alert("Nhập đủ thông tin!");
        const res = await fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': token},
            body: JSON.stringify({ username: uNew.value, password: pNew.value, role: 'user' })
        });
        if (res.ok) { alert("Thành công!"); uNew.value = ""; pNew.value = ""; }
        else alert("Lỗi hoặc API /api/register chưa có trên Server!");
    }
</script>
</body>
</html>