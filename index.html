<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aquarium Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .blink { animation: blinker 1s linear infinite; } 
        @keyframes blinker { 50% { opacity: 0; } }
        /* ·∫®n thanh cu·ªôn cho log nh∆∞ng v·∫´n cu·ªôn ƒë∆∞·ª£c */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 min-h-screen">

    <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform transition-all scale-100">
            <h2 class="text-3xl font-bold text-blue-600 mb-2">üîê ƒêƒÉng Nh·∫≠p</h2>
            <p class="text-gray-500 mb-6 text-sm">H·ªá th·ªëng ƒëi·ªÅu khi·ªÉn b·ªÉ c√° IoT</p>
            <div class="space-y-4">
                <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="login()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition shadow-lg transform active:scale-95">
                    ƒêƒÉng Nh·∫≠p
                </button>
                <p id="loginError" class="text-red-500 text-sm hidden font-bold animate-pulse"></p>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto filter blur-sm transition duration-500" id="mainContent">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-4xl font-extrabold text-blue-600 tracking-tight">üêü B·ªÉ C√° Th√¥ng Minh</h1>
                <p class="text-gray-500 mt-1 text-sm">Xin ch√†o, <span id="userDisplay" class="font-bold text-gray-800">...</span> (<span id="roleDisplay" class="text-blue-600">...</span>)</p>
            </div>
            <button onclick="logout()" class="text-sm bg-white border border-gray-200 hover:bg-red-50 text-gray-600 hover:text-red-600 px-5 py-2.5 rounded-lg font-bold transition shadow-sm flex items-center gap-2">
                ƒêƒÉng xu·∫•t üö™
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="space-y-6">
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative overflow-hidden">
                    <div id="blockClickOverlay" class="hidden absolute inset-0 bg-gray-50 bg-opacity-70 z-10 flex items-center justify-center backdrop-blur-[1px]">
                        <span class="bg-gray-800 text-white text-xs px-4 py-2 rounded-full font-bold shadow-lg">üëÅÔ∏è Ch·∫ø ƒë·ªô ch·ªâ xem (Viewer)</span>
                    </div>

                    <h2 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">üéõÔ∏è ƒêi·ªÅu khi·ªÉn</h2>
                    <div class="space-y-3">
                        <button id="btnAuto" onclick="toggleDevice('autoMode')" class="w-full py-4 rounded-xl font-bold text-white shadow-md bg-gray-400 transition-all">ƒêang t·∫£i...</button>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="btnPump" onclick="toggleDevice('pump')" class="py-4 rounded-xl font-bold text-white shadow-md bg-gray-400 transition-all">M√°y B∆°m</button>
                            <button id="btnLight" onclick="toggleDevice('light')" class="py-4 rounded-xl font-bold text-white shadow-md bg-gray-400 transition-all">ƒê√®n LED</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">üìä Tr·∫°ng Th√°i</h2>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-xl text-center border border-blue-100">
                            <p class="text-sm text-gray-500 mb-1">Nhi·ªát ƒë·ªô</p>
                            <p class="text-3xl font-bold text-blue-600"><span id="temperature">--</span>¬∞C</p>
                        </div>
                        <div class="bg-cyan-50 p-4 rounded-xl text-center border border-cyan-100">
                            <p class="text-sm text-gray-500 mb-1">M·ª±c n∆∞·ªõc</p>
                            <p class="text-3xl font-bold text-cyan-600"><span id="waterLevel">--</span> mm</p>
                        </div>
                    </div>
                    
                    <div class="bg-indigo-50 rounded-xl p-4 border border-indigo-100">
                        <h3 class="text-xs font-bold text-indigo-800 uppercase tracking-wide mb-3 border-b border-indigo-200 pb-2">üì° K·∫øt n·ªëi m·∫°ng</h3>
                        <div class="grid grid-cols-2 gap-y-2 text-sm text-gray-700">
                            <div>WiFi SSID:</div>
                            <div id="wifiName" class="font-bold text-right text-green-600">Checking...</div>
                            <div>T√≠n hi·ªáu:</div>
                            <div id="wifiSignal" class="font-bold text-right text-gray-500">-- dBm</div>
                            <div>IP:</div>
                            <div id="wifiIP" class="font-mono text-right text-gray-600">...</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative">
                    <h2 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">‚öôÔ∏è C√†i ƒë·∫∑t</h2>
                    
                    <div id="settingsControls" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-600 block mb-1">Ng∆∞·ª°ng b∆°m (mm)</label>
                            <div class="flex gap-2">
                                <input type="number" id="thresholdInput" class="flex-1 border rounded-lg px-3 py-2 text-sm outline-none focus:border-blue-500" placeholder="100">
                                <button onclick="setThreshold()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-bold">L∆∞u</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600 block mb-1">L·ªãch ƒë√®n (B·∫≠t ‚ûú T·∫Øt)</label>
                            <div class="flex gap-2">
                                <input type="time" id="lightOn" class="border rounded-lg px-2 py-2 w-full text-sm">
                                <input type="time" id="lightOff" class="border rounded-lg px-2 py-2 w-full text-sm">
                                <button onclick="setLightSchedule()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-bold">ƒê·∫∑t</button>
                            </div>
                        </div>
                    </div>

                    <div id="adminZone" class="hidden border-t-2 border-dashed border-gray-200 pt-6 mt-6 space-y-6">
                        
                        <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                            <h3 class="text-red-800 font-bold text-sm mb-2">‚ö†Ô∏è V√πng nguy hi·ªÉm</h3>
                            <button onclick="requestWifiReset()" class="w-full py-2 bg-red-500 text-white rounded-lg font-bold text-sm hover:bg-red-600 transition shadow-sm flex items-center justify-center gap-2">
                                üîÑ Reset WiFi & C·∫•u h√¨nh l·∫°i
                            </button>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <h3 class="font-bold text-sm mb-3 text-gray-700 flex items-center gap-2">üë• Th√™m t√†i kho·∫£n m·ªõi</h3>
                            <div class="space-y-2">
                                <input id="newUser" type="text" placeholder="T√™n ƒëƒÉng nh·∫≠p m·ªõi" class="w-full p-2 border rounded text-sm outline-none focus:border-green-500">
                                <input id="newPass" type="text" placeholder="M·∫≠t kh·∫©u" class="w-full p-2 border rounded text-sm outline-none focus:border-green-500">
                                <div class="flex gap-2">
                                    <select id="newRole" class="flex-1 p-2 border rounded text-sm bg-white outline-none focus:border-green-500">
                                        <option value="viewer">Viewer (Ch·ªâ xem)</option>
                                        <option value="admin">Admin (Qu·∫£n tr·ªã)</option>
                                    </select>
                                    <button onclick="createUser()" class="bg-green-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-green-700 shadow-sm">Th√™m</button>
                                </div>
                            </div>
                        </div>

                    </div>
                    </div>

            </div>

            <div class="bg-gray-900 text-gray-300 p-6 rounded-2xl shadow-lg h-[600px] flex flex-col font-mono text-sm border border-gray-800">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                    <h2 class="font-bold text-white flex items-center gap-2">üìú Nh·∫≠t K√Ω H·ªá Th·ªëng</h2>
                    <span class="text-xs text-green-400 flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Live</span>
                </div>
                <div id="logContainer" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                    <p class="text-gray-600 italic text-center mt-10">ƒêang ch·ªù d·ªØ li·ªáu...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- AUTH & VARIABLES ---
        let TOKEN = localStorage.getItem('token');
        let ROLE = localStorage.getItem('role');
        let USERNAME = localStorage.getItem('username');

        // H√†m ki·ªÉm tra ƒëƒÉng nh·∫≠p & Ph√¢n quy·ªÅn
function checkAuth() {
    if (!TOKEN) {
        // TR∆Ø·ªúNG H·ª¢P 1: CH∆ØA ƒêƒÇNG NH·∫¨P
        // Hi·ªán Modal, L√†m m·ªù n·ªÅn
        document.getElementById('loginModal').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
        
        // Th√™m hi·ªáu ·ª©ng m·ªù (blur-sm) v√†o n·ªôi dung ch√≠nh
        document.getElementById('mainContent').classList.add('filter', 'blur-sm', 'pointer-events-none');
    } else {
        // TR∆Ø·ªúNG H·ª¢P 2: ƒê√É ƒêƒÇNG NH·∫¨P
        // ·∫®n Modal Login ƒëi
        document.getElementById('loginModal').classList.add('hidden', 'opacity-0', 'pointer-events-none');
        
        // --- S·ª¨A L·ªñI QUAN TR·ªåNG T·∫†I ƒê√ÇY ---
        // X√≥a s·∫°ch c√°c class g√¢y m·ªù (X√≥a c·∫£ blur-sm v√† blur-md ƒë·ªÉ ƒë·∫£m b·∫£o h·∫øt m·ªù 100%)
        document.getElementById('mainContent').classList.remove('filter', 'blur-sm', 'blur-md', 'pointer-events-none');
        
        // Hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng
        document.getElementById('userDisplay').innerText = USERNAME;
        document.getElementById('roleDisplay').innerText = ROLE === 'admin' ? 'Qu·∫£n Tr·ªã Vi√™n' : 'Kh√°ch Xem';
        
        // --- LOGIC PH√ÇN QUY·ªÄN GIAO DI·ªÜN ---
        if (ROLE !== 'admin') {
            // N·∫øu l√† Viewer (Kh√°ch):
            document.getElementById('adminZone').classList.add('hidden');              // ·∫®n v√πng Admin
            document.getElementById('blockClickOverlay').classList.remove('hidden');   // Hi·ªán l·ªõp ph·ªß ch·∫∑n click
            document.getElementById('settingsControls').style.pointerEvents = 'none';  // Kh√≥a n√∫t c√†i ƒë·∫∑t
            document.getElementById('settingsControls').style.opacity = '0.5';         // L√†m m·ªù n√∫t c√†i ƒë·∫∑t
        } else {
            // N·∫øu l√† Admin:
            document.getElementById('adminZone').classList.remove('hidden');           // Hi·ªán v√πng Admin
            document.getElementById('blockClickOverlay').classList.add('hidden');      // B·ªè ch·∫∑n click
            document.getElementById('settingsControls').style.pointerEvents = 'auto';  // M·ªü kh√≥a n√∫t
            document.getElementById('settingsControls').style.opacity = '1';           // L√†m r√µ n√∫t
        }
        
        // B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu
        fetchState();
        fetchLog();
    }
}

        // H√†m Login
        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const errEl = document.getElementById('loginError');

            if(!u || !p) {
                errEl.innerText = "Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!";
                errEl.classList.remove('hidden'); return;
            }

            try {
                const res = await fetch('/login', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                
                if (data.success) {
                    // L∆∞u Session
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('role', data.role);
                    localStorage.setItem('username', data.username);
                    TOKEN = data.token; ROLE = data.role; USERNAME = data.username;
                    
                    // Reset l·ªói & v√†o app
                    errEl.classList.add('hidden');
                    checkAuth();
                } else {
                    errEl.innerText = "‚ùå " + data.error;
                    errEl.classList.remove('hidden');
                }
            } catch(e) { 
                errEl.innerText = "‚ö†Ô∏è L·ªói k·∫øt n·ªëi Server!";
                errEl.classList.remove('hidden');
            }
        }

        function logout() { localStorage.clear(); location.reload(); }

        // --- API HELPER (T·ª± ƒë·ªông g·∫Øn Token) ---
        async function apiCall(endpoint, body) {
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': TOKEN },
                    body: JSON.stringify(body)
                });
                
                if(res.status === 403) {
                    alert("‚õî B·∫†N KH√îNG C√ì QUY·ªÄN TH·ª∞C HI·ªÜN!");
                    return null;
                }

                const data = await res.json();
                if(!data.success) alert("‚ùå L·ªói: " + data.error);
                return data;
            } catch(e) { console.error(e); }
        }

        // --- CONTROL FUNCTIONS ---
        async function toggleDevice(key) {
            if(ROLE !== 'admin') return; // Ch·∫∑n client side tr∆∞·ªõc
            
            // L·∫•y tr·∫°ng th√°i c≈© ƒë·ªÉ ƒë·∫£o ng∆∞·ª£c
            const res = await fetch('/state');
            const state = await res.json();
            const current = state[key] || 0;
            
            await apiCall('/update', { [key]: current ? 0 : 1 });
            fetchState(); // Refresh ngay
        }

        async function setThreshold() { 
            apiCall('/update', { threshold: parseInt(document.getElementById('thresholdInput').value) }); 
            alert("ƒê√£ l∆∞u ng∆∞·ª°ng!");
        }
        
        async function setLightSchedule() { 
            apiCall('/update', { lightSchedule: { on: document.getElementById('lightOn').value, off: document.getElementById('lightOff').value } });
            alert("ƒê√£ l∆∞u l·ªãch!");
        }

        async function requestWifiReset() { 
            if(confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: Thi·∫øt b·ªã s·∫Ω m·∫•t m·∫°ng v√† c·∫ßn c·∫•u h√¨nh l·∫°i!\nB·∫°n ch·∫Øc ch·∫Øn ch·ª©?")) {
                const res = await apiCall('/reset-wifi', {});
                if(res && res.success) alert("‚úÖ ƒê√£ g·ª≠i l·ªánh Reset! ƒê√®n tr√™n thi·∫øt b·ªã s·∫Ω nh√°y li√™n t·ª•c.");
            }
        }
        
        async function createUser() {
            const u = document.getElementById('newUser').value;
            const p = document.getElementById('newPass').value;
            const r = document.getElementById('newRole').value;
            if(!u || !p) return alert("Nh·∫≠p thi·∫øu th√¥ng tin!");
            
            const data = await apiCall('/register', { newUsername: u, newPassword: p, newRole: r });
            if(data && data.success) { 
                alert("‚úÖ " + data.message); 
                document.getElementById('newUser').value=''; 
                document.getElementById('newPass').value=''; 
            }
        }

        // --- DISPLAY FUNCTIONS ---
        async function fetchState() {
            if(!TOKEN) return; // Kh√¥ng c√≥ token kh√¥ng g·ªçi
            try {
                const res = await fetch('/state');
                const data = await res.json();
                
                updateButton('btnAuto', data.autoMode, 'ü§ñ T·ª± ƒê·ªông: B·∫¨T', 'ü§ñ T·ª± ƒê·ªông: T·∫ÆT');
                updateButton('btnPump', data.pump, 'üåä M√°y B∆°m: ƒêANG CH·∫†Y', 'üåä M√°y B∆°m: ƒêANG T·∫ÆT');
                updateButton('btnLight', data.light, 'üí° ƒê√®n LED: ƒêANG S√ÅNG', 'üí° ƒê√®n LED: ƒêANG T·∫ÆT');

                document.getElementById('temperature').innerText = data.temperature;
                document.getElementById('waterLevel').innerText = data.waterLevel;
                
                // WiFi Info
                const wifiEl = document.getElementById('wifiName');
                wifiEl.innerText = data.wifiSSID;
                if(data.wifiSSID === 'Disconnect' || data.wifiSSID === 'Reseting...') {
                    wifiEl.className = 'font-bold text-right text-red-500 blink';
                } else {
                    wifiEl.className = 'font-bold text-right text-green-600';
                }
                document.getElementById('wifiIP').innerText = data.ip;
                document.getElementById('wifiSignal').innerText = data.rssi + " dBm";
                
                // Inputs placeholder
                if(document.activeElement.id !== 'thresholdInput') document.getElementById('thresholdInput').placeholder = data.threshold;

            } catch(e) {}
        }

        function updateButton(id, state, txtOn, txtOff) {
            const btn = document.getElementById(id);
            if(state) {
                btn.innerText = txtOn;
                btn.className = "w-full py-4 rounded-xl font-bold text-white shadow-md bg-green-500 hover:bg-green-600 transition-all";
            } else {
                btn.innerText = txtOff;
                btn.className = "w-full py-4 rounded-xl font-bold text-white shadow-md bg-gray-400 hover:bg-gray-500 transition-all";
            }
        }

        async function fetchLog() {
            if(!TOKEN) return;
            const res = await fetch('/log');
            const logs = await res.json();
            const container = document.getElementById('logContainer');
            container.innerHTML = '';
            
            logs.forEach(l => {
                const div = document.createElement('div');
                div.className = "border-l-2 pl-2 border-gray-700 hover:bg-gray-800 p-1 rounded transition";
                const time = new Date(l.timestamp).toLocaleTimeString('vi-VN');
                
                let color = "text-gray-300";
                if(l.source === 'auto') color = "text-yellow-400";
                if(l.source === 'web') color = "text-blue-400";
                if(l.source === 'button') color = "text-purple-400";
                
                div.innerHTML = `<span class="text-gray-500 text-xs font-mono">[${time}]</span> <span class="${color}">${l.message}</span>`;
                container.appendChild(div);
            });
        }

        // --- INIT ---
        checkAuth(); // Ch·∫°y ki·ªÉm tra ngay khi m·ªü trang
        setInterval(() => { if(TOKEN) { fetchState(); } }, 1000);
        setInterval(() => { if(TOKEN) { fetchLog(); } }, 3000);
    </script>
</body>
</html>